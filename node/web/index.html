<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>P2P Mesh Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #0b1020; color: #e6e6e6; }
    header { padding: 12px 16px; background: #121a35; position: sticky; top:0; }
    #controls { margin-top:8px; display:flex; gap:8px; }
    #controls input { flex: none; width:120px; }
    #log { padding: 16px; height: calc(100vh - 180px); overflow-y: auto; }
    .msg { margin: 8px 0; padding: 8px 12px; background: #161f3f; border-radius: 10px; }
    .meta { font-size: 12px; opacity: .7; margin-bottom: 2px; }
    footer { position: fixed; bottom: 0; left:0; right:0; background: #121a35; padding: 8px 12px; display:flex; gap:8px; }
    footer input { flex:1; padding: 10px 12px; border-radius: 8px; border: 1px solid #28345f; background:#0f1530; color:#e6e6e6; }
    button { padding: 10px 16px; border-radius: 8px; border: 0; background:#3b82f6; color:white; cursor:pointer; }
    button:disabled{opacity:.6; cursor:not-allowed;}
  </style>
</head>
<body>
  <header>
    <strong>P2P Mesh Chat</strong>
    <div id="status" style="font-size:12px; opacity:.8;"></div>
    <div id="controls">
      <input id="nick" placeholder="nickname" />
      <input id="room" placeholder="room" />
      <button id="apply">Apply</button>
    </div>
  </header>
  <div id="log"></div>
  <footer>
    <input id="txt" placeholder="Type a message and press Enter..." />
    <button id="send">Send</button>
  </footer>

<script>
  const log = document.getElementById('log');
  const txt = document.getElementById('txt');
  const btn = document.getElementById('send');
  const status = document.getElementById('status');
  const nick = document.getElementById('nick');
  const room = document.getElementById('room');
  const apply = document.getElementById('apply');

  function addMsg({from, text, ts}) {
    const div = document.createElement('div');
    div.className = 'msg';
    const when = new Date((ts||Date.now()/1000)*1000).toLocaleString();
    div.innerHTML = `<div class="meta">${from} • ${when}</div><div>${text}</div>`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  let ws;
  function connect() {␊
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';␊
    ws = new WebSocket(`${proto}://${location.host}/ws`);␊
    ws.onopen = () => { status.textContent = 'Connected'; btn.disabled = false; };
    ws.onclose = () => { status.textContent = 'Disconnected — retrying...'; btn.disabled = true; setTimeout(connect, 1500); };
    ws.onerror = () => { status.textContent = 'Error'; };
    ws.onmessage = (ev) => {
      try { addMsg(JSON.parse(ev.data)); } catch {}
    };
  }
  connect();

  function loadConfig() {
    fetch('/config').then(r => r.json()).then(cfg => {
      nick.value = cfg.nick || '';
      room.value = cfg.room || '';
      status.textContent = `Room: ${cfg.room} • Nick: ${cfg.nick}`;
    }).catch(() => {});
  }
  loadConfig();

  function send() {
    const t = txt.value.trim();
    if (!t || !ws || ws.readyState !== 1) return;
    ws.send(t);
    txt.value = '';
  }
  btn.onclick = send;
  txt.onkeydown = (e) => { if (e.key === 'Enter') send(); };
  apply.onclick = () => {
    const body = {nick: nick.value.trim(), room: room.value.trim()};
    fetch('/config', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)})
      .then(() => { loadConfig(); log.innerHTML=''; });
  };
</script>
</body>
</html>